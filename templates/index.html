{% extends "layouts/module.html" %}

{% block title %}首页 - 股票交易游戏{% endblock %}

{% block module_title %}欢迎来到股票交易游戏{% endblock %}

{% block module_actions %}
{% if session.get('user_id') %}
<a href="{{ url_for('company.create_page') }}" class="btn create-btn">创建公司</a>
{% endif %}
{% endblock %}

{% block module_content %}
<div class="market-data">
    <div class="companies-section">
        <h3>上市公司</h3>
        <div id="companiesList" class="companies-grid">
            <!-- 公司列表将通过JavaScript动态加载 -->
        </div>
    </div>

    {% if session.get('user_id') %}
    <div class="holdings-section">
        <h3>我的持股</h3>
        <div id="holdingsList" class="holdings-grid">
            <!-- 持股信息将通过JavaScript动态加载 -->
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// 加载公司列表
async function loadCompanies() {
    try {
        const response = await fetch('/company/list');
        const result = await response.json();
        if (result.success) {
            const companiesList = document.getElementById('companiesList');
            companiesList.innerHTML = result.data.map(company => {
                return `
                    <div class="company-card">
                        <div class="company-header">
                            <h4>${company.name}</h4>
                            <span class="company-type">${company.is_ai ? 'AI公司' : '玩家公司'}</span>
                        </div>
                        <div class="company-info">
                            <div class="info-item">
                                <label>当前股价</label>
                                <span class="price">${formatMoney(company.current_price)}</span>
                            </div>
                            <div class="info-item">
                                <label>可用股份</label>
                                <span>${formatNumber(company.available_shares)}</span>
                            </div>
                            <div class="info-item">
                                <label>总股份</label>
                                <span>${formatNumber(company.total_shares)}</span>
                            </div>
                        </div>
                        <div class="company-actions">
                            <a href="/company/info/${company.id}" class="btn">查看详情</a>
                        </div>
                    </div>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('加载公司列表失败:', error);
        const companiesList = document.getElementById('companiesList');
        companiesList.innerHTML = '<div class="error-message">加载公司列表失败</div>';
    }
}

// 加载持股信息
async function loadHoldings() {
    const holdingsList = document.getElementById('holdingsList');
    if (!holdingsList) return;

    try {
        const response = await fetch('/trading/holdings');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const result = await response.json();
        if (result.success) {
            holdingsList.innerHTML = result.data.map(holding => {
                return `
                    <div class="holding-card">
                        <div class="holding-header">
                            <h4>${holding.company_name}</h4>
                        </div>
                        <div class="holding-info">
                            <div class="info-item">
                                <label>持有股数</label>
                                <span>${formatNumber(holding.shares)}</span>
                            </div>
                            <div class="info-item">
                                <label>当前价值</label>
                                <span class="value">${formatMoney(holding.total_value)}</span>
                            </div>
                        </div>
                        <div class="holding-actions">
                            <a href="/company/info/${holding.company_id}" class="btn">交易</a>
                        </div>
                    </div>
                `;
            }).join('') || '<div class="empty-message">暂无持股</div>';
        }
    } catch (error) {
        console.error('加载持股信息失败:', error);
        holdingsList.innerHTML = '<div class="error-message">加载持股信息失败</div>';
    }
}

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', () => {
    loadCompanies();
    loadHoldings();
});
</script>
{% endblock %} 