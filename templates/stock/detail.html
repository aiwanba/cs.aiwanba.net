{% extends "base.html" %}

{% block title %}{{ company.name }} - 股票详情{% endblock %}

{% block content %}
<div class="container">
    <!-- 公司基本信息 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title">{{ company.name }} <small class="text-muted">({{ company.code }})</small></h3>
                    <div class="row">
                        <div class="col-md-4">
                            <p>当前价格：<span class="h4">¥{{ "%.2f"|format(company.current_price) }}</span></p>
                        </div>
                        <div class="col-md-4">
                            <p>总市值：¥{{ "{:,.2f}".format(company.market_value) }}</p>
                        </div>
                        <div class="col-md-4">
                            <p>总股本：{{ "{:,}".format(company.total_shares) }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 左侧：K线图 -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">K线图</h5>
                    <div id="kline" style="height: 400px;"></div>
                </div>
            </div>
        </div>

        <!-- 右侧：盘口和成交 -->
        <div class="col-md-4">
            <!-- 买卖盘口 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">买卖盘口</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>买入</th>
                                    <th>价格</th>
                                    <th>数量</th>
                                </tr>
                            </thead>
                            <tbody id="buy-orders">
                                <!-- 买盘数据将通过JavaScript动态更新 -->
                            </tbody>
                        </table>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>卖出</th>
                                    <th>价格</th>
                                    <th>数量</th>
                                </tr>
                            </thead>
                            <tbody id="sell-orders">
                                <!-- 卖盘数据将通过JavaScript动态更新 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 最近成交 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">最近成交</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>价格</th>
                                    <th>数量</th>
                                </tr>
                            </thead>
                            <tbody id="recent-trades">
                                <!-- 成交数据将通过JavaScript动态更新 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 交易面板 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">交易</h5>
                    <form id="trade-form" method="post" action="{{ url_for('trade_stock', code=company.code) }}">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>交易类型</label>
                                    <select class="form-control" name="action" required>
                                        <option value="buy">买入</option>
                                        <option value="sell">卖出</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>价格</label>
                                    <input type="number" class="form-control" name="price" step="0.01" min="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>数量</label>
                                    <input type="number" class="form-control" name="shares" min="1" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="submit" class="btn btn-primary btn-block">提交委托</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    // 初始化K线图
    function initKline() {
        $.get('/api/stock/{{ company.code }}/kline', function(data) {
            if (data.error) {
                console.error(data.error);
                return;
            }
            
            var myChart = echarts.init(document.getElementById('kline'));
            var option = {
                title: { text: '{{ company.name }} - K线图' },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: data.map(item => item.time),
                    scale: true
                },
                yAxis: {
                    type: 'value',
                    scale: true,
                    splitArea: {
                        show: true
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: 60,
                        start: 0,
                        end: 100
                    }
                ],
                series: [{
                    type: 'candlestick',
                    data: data.map(item => [
                        item.open,
                        item.close,
                        item.low,
                        item.high
                    ])
                }]
            };
            myChart.setOption(option);
           
            // 自适应容器大小
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        });
    }
    
    // 更新盘口数据
    function updateOrderbook() {
        $.get('/api/stock/{{ company.code }}/orderbook', function(data) {
            if (data.error) return;
            
            // 更新买盘
            var buyHtml = data.buy.map(function(order) {
                return `<tr>
                    <td>买入</td>
                    <td>${order.price.toFixed(2)}</td>
                    <td>${order.volume.toLocaleString()}</td>
                </tr>`;
            }).join('');
            $('#buy-orders').html(buyHtml);
            
            // 更新卖盘
            var sellHtml = data.sell.map(function(order) {
                return `<tr>
                    <td>卖出</td>
                    <td>${order.price.toFixed(2)}</td>
                    <td>${order.volume.toLocaleString()}</td>
                </tr>`;
            }).join('');
            $('#sell-orders').html(sellHtml);
        });
    }
    
    // 更新成交记录
    function updateTrades() {
        $.get('/api/stock/{{ company.code }}/trades', function(data) {
            if (data.error) return;
            
            var tradesHtml = data.map(function(trade) {
                return `<tr>
                    <td>${trade.time}</td>
                    <td>${trade.price.toFixed(2)}</td>
                    <td>${trade.volume.toLocaleString()}</td>
                </tr>`;
            }).join('');
            $('#recent-trades').html(tradesHtml);
        });
    }
    
    // 页面加载完成后初始化
    $(document).ready(function() {
        initKline();
        updateOrderbook();
        updateTrades();
        
        // 定时更新数据
        setInterval(function() {
            updateOrderbook();
            updateTrades();
        }, 5000);  // 每5秒更新一次
    });
</script>
{% endblock %} 