{% extends "base.html" %}

{% block title %}{{ team.name }} - 股票交易游戏{% endblock %}

{% block content %}
<div class="team-container">
    <div class="team-header">
        <div class="team-info">
            <h2>{{ team.name }}</h2>
            <p class="team-desc">{{ team.description }}</p>
            <div class="team-meta">
                <span>创建时间: {{ team.created_at.strftime('%Y-%m-%d') }}</span>
                <span>成员数: {{ team.members|length }}</span>
                <span>讨论数: {{ team.discussions|length }}</span>
            </div>
        </div>
        {% if not is_member %}
        <button class="btn join-btn" data-team-id="{{ team.id }}">加入团队</button>
        {% endif %}
    </div>

    <div class="team-content">
        <div class="members-section">
            <h3>团队成员</h3>
            <div class="members-list">
                {% for member in team.members %}
                <div class="member-card">
                    <div class="member-info">
                        <span class="member-name">{{ member.user.username }}</span>
                        <span class="member-role">{{ member.role }}</span>
                    </div>
                    <span class="join-time">加入时间: {{ member.joined_at.strftime('%Y-%m-%d') }}</span>
                    {% if is_leader and member.user_id != session.user_id %}
                    <button class="btn remove-member" data-user-id="{{ member.user_id }}">移除</button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="discussions-section">
            <div class="section-header">
                <h3>团队讨论</h3>
                {% if is_member %}
                <button class="btn" id="newDiscussionBtn">发起讨论</button>
                {% endif %}
            </div>

            <div class="discussions-list">
                {% for discussion in team.discussions %}
                <div class="discussion-card" id="discussion-{{ discussion.id }}">
                    <div class="discussion-header">
                        <div class="discussion-meta">
                            <span class="author">{{ discussion.user.username }}</span>
                            <span class="time">{{ discussion.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                        <h4>{{ discussion.title }}</h4>
                    </div>
                    <div class="discussion-content">{{ discussion.content }}</div>
                    
                    <div class="comments-section">
                        <h5>评论 ({{ discussion.comments|length }})</h5>
                        <div class="comments-list">
                            {% for comment in discussion.comments %}
                            <div class="comment-item">
                                <div class="comment-meta">
                                    <span class="author">{{ comment.user.username }}</span>
                                    <span class="time">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                </div>
                                <div class="comment-content">{{ comment.content }}</div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if is_member %}
                        <form class="comment-form" data-discussion-id="{{ discussion.id }}">
                            <textarea class="comment-input" placeholder="发表评论..." required></textarea>
                            <button type="submit" class="btn">评论</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- 新建讨论对话框 -->
<div class="modal" id="newDiscussionModal">
    <div class="modal-content">
        <h3>发起讨论</h3>
        <form id="newDiscussionForm">
            <div class="form-group">
                <label>标题</label>
                <input type="text" name="title" required>
            </div>
            <div class="form-group">
                <label>内容</label>
                <textarea name="content" required></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" id="cancelDiscussion">取消</button>
                <button type="submit" class="btn">发布</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 处理加入团队
const joinBtn = document.querySelector('.join-btn');
if (joinBtn) {
    joinBtn.addEventListener('click', async () => {
        const teamId = joinBtn.dataset.teamId;
        try {
            const response = await fetch('/social/team/join', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    team_id: teamId
                })
            });
            const result = await response.json();
            alert(result.message);
            if (result.success) {
                location.reload();
            }
        } catch (error) {
            alert('加入失败，请重试');
        }
    });
}

// 处理移除成员
document.querySelectorAll('.remove-member').forEach(btn => {
    btn.addEventListener('click', async () => {
        if (!confirm('确定要移除该成员吗？')) return;
        
        const userId = btn.dataset.userId;
        try {
            const response = await fetch('/social/team/remove-member', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    team_id: {{ team.id }},
                    user_id: userId
                })
            });
            const result = await response.json();
            alert(result.message);
            if (result.success) {
                location.reload();
            }
        } catch (error) {
            alert('操作失败，请重试');
        }
    });
});

// 处理新建讨论
const modal = document.getElementById('newDiscussionModal');
const newDiscussionBtn = document.getElementById('newDiscussionBtn');
const cancelBtn = document.getElementById('cancelDiscussion');

if (newDiscussionBtn) {
    newDiscussionBtn.addEventListener('click', () => {
        modal.style.display = 'block';
    });
}

if (cancelBtn) {
    cancelBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });
}

const newDiscussionForm = document.getElementById('newDiscussionForm');
if (newDiscussionForm) {
    newDiscussionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(newDiscussionForm);
        
        try {
            const response = await fetch('/social/discussion/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    team_id: {{ team.id }},
                    title: formData.get('title'),
                    content: formData.get('content')
                })
            });
            const result = await response.json();
            alert(result.message);
            if (result.success) {
                location.reload();
            }
        } catch (error) {
            alert('发布失败，请重试');
        }
    });
}

// 处理评论提交
document.querySelectorAll('.comment-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const discussionId = form.dataset.discussionId;
        const content = form.querySelector('.comment-input').value;
        
        try {
            const response = await fetch('/social/discussion/comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    discussion_id: discussionId,
                    content: content
                })
            });
            const result = await response.json();
            alert(result.message);
            if (result.success) {
                location.reload();
            }
        } catch (error) {
            alert('评论失败，请重试');
        }
    });
});
</script>
{% endblock %} 