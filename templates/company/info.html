{% extends "base.html" %}

{% block title %}{{ company.name }} - 股票交易游戏{% endblock %}

{% block content %}
<div class="company-detail">
    <div class="company-header">
        <h2>{{ company.name }}</h2>
        <div class="company-stats">
            <div class="stat">
                <label>当前股价</label>
                <span class="price">¥{{ "%.2f"|format(company.current_price) }}</span>
            </div>
            <div class="stat">
                <label>可用股份</label>
                <span>{{ company.available_shares }}</span>
            </div>
            <div class="stat">
                <label>总股份</label>
                <span>{{ company.total_shares }}</span>
            </div>
        </div>
    </div>

    <div class="company-info">
        <h3>公司简介</h3>
        <p>{{ company.description }}</p>
    </div>

    {% if session.get('user_id') %}
    <div class="trading-panel">
        <h3>交易面板</h3>
        <div class="trading-forms">
            <form id="buyForm" class="trade-form">
                <h4>买入</h4>
                <div class="form-group">
                    <label for="buyShares">股数</label>
                    <input type="number" id="buyShares" min="1" required>
                </div>
                <div class="form-group">
                    <label for="buyPrice">价格</label>
                    <input type="number" id="buyPrice" min="0.01" step="0.01" required>
                </div>
                <button type="submit" class="btn">买入</button>
            </form>

            <form id="sellForm" class="trade-form">
                <h4>卖出</h4>
                <div class="form-group">
                    <label for="sellShares">股数</label>
                    <input type="number" id="sellShares" min="1" required>
                </div>
                <div class="form-group">
                    <label for="sellPrice">价格</label>
                    <input type="number" id="sellPrice" min="0.01" step="0.01" required>
                </div>
                <button type="submit" class="btn">卖出</button>
            </form>
        </div>
    </div>

    <div class="my-holding">
        <h3>我的持股</h3>
        <div id="myHolding">
            <!-- 持股信息将通过JavaScript动态加载 -->
        </div>
    </div>
    {% endif %}

    <div class="transaction-history">
        <h3>最近交易</h3>
        <div id="transactions">
            <!-- 交易历史将通过JavaScript动态加载 -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const companyId = {{ company.id }};

// 加载我的持股信息
async function loadMyHolding() {
    const holdingDiv = document.getElementById('myHolding');
    if (!holdingDiv) return;

    try {
        const response = await fetch('/trading/holdings');
        const result = await response.json();
        if (result.success) {
            const holding = result.data.find(h => h.company_id === companyId);
            if (holding) {
                holdingDiv.innerHTML = `
                    <div class="holding-info">
                        <p>持有股数：${formatNumber(holding.shares)}</p>
                        <p>当前价值：${formatMoney(holding.total_value)}</p>
                    </div>
                `;
            } else {
                holdingDiv.innerHTML = '<p>暂无持股</p>';
            }
        }
    } catch (error) {
        console.error('加载持股信息失败:', error);
    }
}

// 加载最近交易历史
async function loadTransactions() {
    const transactionsDiv = document.getElementById('transactions');
    try {
        const response = await fetch(`/company/${companyId}/transactions`);
        const result = await response.json();
        if (result.success) {
            transactionsDiv.innerHTML = result.data.map(tx => `
                <div class="transaction-item">
                    <span class="time">${tx.created_at}</span>
                    <span class="type">${tx.type}</span>
                    <span class="shares">${formatNumber(tx.shares)}股</span>
                    <span class="price">${formatMoney(tx.price)}</span>
                </div>
            `).join('') || '<p>暂无交易记录</p>';
        }
    } catch (error) {
        console.error('加载交易历史失败:', error);
    }
}

// 处理买入表单提交
document.getElementById('buyForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const shares = parseInt(document.getElementById('buyShares').value);
    const price = parseFloat(document.getElementById('buyPrice').value);
    
    try {
        const response = await fetch('/trading/buy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                company_id: companyId,
                shares,
                price
            })
        });
        const result = await response.json();
        alert(result.message);
        if (result.success) {
            loadMyHolding();
            loadTransactions();
        }
    } catch (error) {
        alert('买入失败，请重试');
    }
});

// 处理卖出表单提交
document.getElementById('sellForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const shares = parseInt(document.getElementById('sellShares').value);
    const price = parseFloat(document.getElementById('sellPrice').value);
    
    try {
        const response = await fetch('/trading/sell', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                company_id: companyId,
                shares,
                price
            })
        });
        const result = await response.json();
        alert(result.message);
        if (result.success) {
            loadMyHolding();
            loadTransactions();
        }
    } catch (error) {
        alert('卖出失败，请重试');
    }
});

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', () => {
    loadMyHolding();
    loadTransactions();
});
</script>
{% endblock %} 