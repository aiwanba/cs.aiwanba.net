{% extends "base.html" %}

{% block title %}{{ company.name }} - 公司详情{% endblock %}

{% block content %}
<div class="container">
    <!-- 公司基本信息 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title">{{ company.name }} <small class="text-muted">({{ company.code }})</small></h3>
                    <div class="row">
                        <div class="col-md-3">
                            <p>当前价格：<span class="h4 {{ 'text-danger' if company.change_percent > 0 else 'text-success' if company.change_percent < 0 else '' }}">
                                ¥{{ "%.2f"|format(company.current_price) }}
                                ({{ "%.2f"|format(company.change_percent) }}%)
                            </span></p>
                        </div>
                        <div class="col-md-3">
                            <p>总市值：¥{{ "{:,.2f}".format(company.market_value) }}</p>
                        </div>
                        <div class="col-md-3">
                            <p>总股本：{{ "{:,}".format(company.total_shares) }}</p>
                        </div>
                        <div class="col-md-3">
                            <p>所属行业：{{ company.industry }}</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p class="mb-0">{{ company.description }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 交易区域 -->
    <div class="row">
        <div class="col-md-8">
            <!-- K线图 -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">K线图</h5>
                    <div id="kline" style="height: 400px;"></div>
                </div>
            </div>

            <!-- 交易表单 -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">交易下单</h5>
                    <form id="tradeForm">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>交易类型</label>
                                    <select class="form-select" name="type" required>
                                        <option value="buy">买入</option>
                                        <option value="sell">卖出</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>价格</label>
                                    <input type="number" class="form-control" name="price" step="0.01" min="0.01" required>
                                    <div class="form-text">当前价格：¥{{ "%.2f"|format(company.current_price) }}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>数量</label>
                                    <input type="number" class="form-control" name="shares" min="100" step="100" required>
                                    <div class="form-text">最小交易单位：100股</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="submit" class="btn btn-primary btn-block w-100">提交委托</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- 买卖盘口 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">盘口</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>买入</th>
                                    <th>价格</th>
                                    <th>数量</th>
                                </tr>
                            </thead>
                            <tbody id="buy-orders">
                                <!-- 买盘数据将通过JavaScript动态更新 -->
                            </tbody>
                        </table>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>卖出</th>
                                    <th>价格</th>
                                    <th>数量</th>
                                </tr>
                            </thead>
                            <tbody id="sell-orders">
                                <!-- 卖盘数据将通过JavaScript动态更新 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 最近成交 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">最近成交</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>价格</th>
                                    <th>数量</th>
                                </tr>
                            </thead>
                            <tbody id="recent-trades">
                                <!-- 成交数据将通过JavaScript动态更新 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    var klineChart = null;  // 保存K线图实例

    // 初始化K线图
    function initKline() {
        $.get('/api/stock/{{ company.code }}/kline', function(data) {
            if (data.error) {
                console.error(data.error);
                return;
            }
            
            if (!klineChart) {
                klineChart = echarts.init(document.getElementById('kline'));
            }
            
            var option = {
                title: { text: '{{ company.name }} - K线图' },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: { data: ['K线', '成交量'] },
                grid: [
                    { left: '10%', right: '10%', height: '60%' },
                    { left: '10%', right: '10%', top: '75%', height: '15%' }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: data.map(item => item.categoryData),
                        scale: true
                    },
                    {
                        type: 'category',
                        gridIndex: 1,
                        data: data.map(item => item.categoryData),
                        scale: true
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        splitArea: { show: true }
                    },
                    {
                        gridIndex: 1,
                        splitNumber: 2,
                        axisLabel: { show: false }
                    }
                ],
                dataZoom: [
                    { type: 'inside', xAxisIndex: [0, 1], start: 50, end: 100 },
                    { show: true, xAxisIndex: [0, 1], type: 'slider', bottom: '0%', start: 50, end: 100 }
                ],
                series: [
                    {
                        name: 'K线',
                        type: 'candlestick',
                        data: data.map(item => item.values)
                    },
                    {
                        name: '成交量',
                        type: 'bar',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: data.map(item => item.volumeData)
                    }
                ]
            };
            klineChart.setOption(option);
        });
    }

    // 自适应容器大小
    window.addEventListener('resize', function() {
        if (klineChart) {
            klineChart.resize();
        }
    });

    // 更新盘口数据
    function updateOrderbook() {
        $.get('/api/stock/{{ company.code }}/orderbook', function(data) {
            if (data.error) return;

            // 更新买盘
            var buyHtml = data.buy.map(function(order) {
                return `<tr>
                    <td>买入</td>
                    <td>${order.price.toFixed(2)}</td>
                    <td>${order.volume.toLocaleString()}</td>
                </tr>`;
            }).join('');
            $('#buy-orders').html(buyHtml);

            // 更新卖盘
            var sellHtml = data.sell.map(function(order) {
                return `<tr>
                    <td>卖出</td>
                    <td>${order.price.toFixed(2)}</td>
                    <td>${order.volume.toLocaleString()}</td>
                </tr>`;
            }).join('');
            $('#sell-orders').html(sellHtml);
        });
    }

    // 更新成交记录
    function updateTrades() {
        $.get('/api/stock/{{ company.code }}/trades', function(data) {
            if (data.error) return;

            var tradesHtml = data.map(function(trade) {
                return `<tr>
                    <td>${trade.time}</td>
                    <td>${trade.price.toFixed(2)}</td>
                    <td>${trade.volume.toLocaleString()}</td>
                </tr>`;
            }).join('');
            $('#recent-trades').html(tradesHtml);
        });
    }

    // 处理交易表单提交
    document.getElementById('tradeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const type = formData.get('type');
        const price = parseFloat(formData.get('price'));
        const shares = parseInt(formData.get('shares'));
        
        // 基本验证
        if (shares % 100 !== 0) {
            alert('交易数量必须是100的整数倍');
            return;
        }
        
        if (price <= 0) {
            alert('价格必须大于0');
            return;
        }
        
        // 发送交易请求
        fetch('/api/stock/{{ company.code }}/trade', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('委托已提交');
                this.reset();
                updateOrderbook();
                updateTrades();
            } else {
                alert('委托失败：' + (data.message || '请稍后重试'));
            }
        });
    });
    
    // 页面加载完成后初始化
    $(document).ready(function() {
        initKline();
        updateOrderbook();
        updateTrades();
        
        // 定时更新数据
        setInterval(function() {
            updateOrderbook();
            updateTrades();
            initKline();  // 同时更新K线图
        }, 5000);  // 每5秒更新一次
    });
</script>
{% endblock %} 