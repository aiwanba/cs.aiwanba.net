{% extends "base.html" %}

{% block title %}市场分析 - 股票交易游戏{% endblock %}

{% block head %}
{{ super() }}
<!-- 引入ECharts图表库 -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
{% endblock %}

{% block content %}
<div class="analysis-container">
    <div class="analysis-header">
        <h2>市场分析</h2>
        <div class="analysis-nav">
            <button class="btn active" data-tab="market">市场概览</button>
            <button class="btn" data-tab="company">个股分析</button>
            <button class="btn" data-tab="technical">技术指标</button>
        </div>
    </div>

    <div class="analysis-content">
        <!-- 市场概览 -->
        <div class="analysis-tab active" id="market-tab">
            <div class="market-overview">
                <div class="overview-cards">
                    <div class="overview-card">
                        <h4>总市值</h4>
                        <div class="value" id="totalMarketValue">--</div>
                        <div class="change up">+2.5%</div>
                    </div>
                    <div class="overview-card">
                        <h4>成交量</h4>
                        <div class="value" id="tradingVolume">--</div>
                        <div class="change down">-1.2%</div>
                    </div>
                    <div class="overview-card">
                        <h4>活跃公司</h4>
                        <div class="value" id="activeCompanies">--</div>
                        <div class="change">0%</div>
                    </div>
                    <div class="overview-card">
                        <h4>市场指数</h4>
                        <div class="value" id="marketIndex">--</div>
                        <div class="change up">+1.8%</div>
                    </div>
                </div>
                <div class="chart-container">
                    <div id="marketChart" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
        </div>

        <!-- 个股分析 -->
        <div class="analysis-tab" id="company-tab">
            <div class="company-selector">
                <select id="companySelect">
                    <option value="">选择公司...</option>
                    {% for company in companies %}
                    <option value="{{ company.id }}">{{ company.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="company-analysis">
                <div class="chart-container">
                    <div id="candlestickChart" style="width: 100%; height: 400px;"></div>
                </div>
                <div class="company-metrics">
                    <div class="metric-card">
                        <h4>市盈率(P/E)</h4>
                        <div class="value" id="peRatio">--</div>
                    </div>
                    <div class="metric-card">
                        <h4>市净率(P/B)</h4>
                        <div class="value" id="pbRatio">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 技术指标 -->
        <div class="analysis-tab" id="technical-tab">
            <div class="technical-charts">
                <div class="chart-container">
                    <div id="maChart" style="width: 100%; height: 300px;"></div>
                </div>
                <div class="chart-container">
                    <div id="rsiChart" style="width: 100%; height: 200px;"></div>
                </div>
                <div class="chart-container">
                    <div id="kdjChart" style="width: 100%; height: 200px;"></div>
                </div>
                <div class="chart-container">
                    <div id="macdChart" style="width: 100%; height: 200px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 初始化图表实例
const marketChart = echarts.init(document.getElementById('marketChart'));
const candlestickChart = echarts.init(document.getElementById('candlestickChart'));
const maChart = echarts.init(document.getElementById('maChart'));
const rsiChart = echarts.init(document.getElementById('rsiChart'));
const kdjChart = echarts.init(document.getElementById('kdjChart'));
const macdChart = echarts.init(document.getElementById('macdChart'));

// 处理标签切换
document.querySelectorAll('.analysis-nav .btn').forEach(btn => {
    btn.addEventListener('click', () => {
        // 移除所有active类
        document.querySelectorAll('.analysis-nav .btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.analysis-tab').forEach(tab => tab.classList.remove('active'));
        
        // 添加active类到当前按钮和对应的标签页
        btn.classList.add('active');
        document.getElementById(`${btn.dataset.tab}-tab`).classList.add('active');
        
        // 重新渲染图表
        window.dispatchEvent(new Event('resize'));
    });
});

// 加载市场数据
async function loadMarketData() {
    try {
        const response = await fetch('/analysis/market');
        const result = await response.json();
        if (result.success) {
            updateMarketOverview(result.data[0]);
            updateMarketChart(result.data);
        }
    } catch (error) {
        console.error('加载市场数据失败:', error);
    }
}

// 加载公司数据
async function loadCompanyData(companyId) {
    try {
        const response = await fetch(`/analysis/company/${companyId}`);
        const result = await response.json();
        if (result.success) {
            updateCompanyAnalysis(result.data);
        }
    } catch (error) {
        console.error('加载公司数据失败:', error);
    }
}

// 加载技术指标
async function loadTechnicalData(companyId) {
    try {
        const response = await fetch(`/analysis/technical/${companyId}`);
        const result = await response.json();
        if (result.success) {
            updateTechnicalCharts(result.data);
        }
    } catch (error) {
        console.error('加载技术指标失败:', error);
    }
}

// 更新市场概览
function updateMarketOverview(data) {
    document.getElementById('totalMarketValue').textContent = 
        (data.market_value / 100000000).toFixed(2) + '亿';
    document.getElementById('tradingVolume').textContent = 
        (data.trading_volume / 10000).toFixed(2) + '万';
    document.getElementById('activeCompanies').textContent = 
        data.active_companies;
    document.getElementById('marketIndex').textContent = 
        data.price_index.toFixed(2);
}

// 更新市场图表
function updateMarketChart(data) {
    const option = {
        title: {
            text: '市场趋势'
        },
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['市场指数', '成交量']
        },
        xAxis: {
            type: 'category',
            data: data.map(item => item.date)
        },
        yAxis: [
            {
                type: 'value',
                name: '指数'
            },
            {
                type: 'value',
                name: '成交量'
            }
        ],
        series: [
            {
                name: '市场指数',
                type: 'line',
                data: data.map(item => item.price_index)
            },
            {
                name: '成交量',
                type: 'bar',
                yAxisIndex: 1,
                data: data.map(item => item.trading_volume)
            }
        ]
    };
    marketChart.setOption(option);
}

// 更新K线图
function updateCandlestickChart(data) {
    const option = {
        title: {
            text: '股票K线'
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            }
        },
        xAxis: {
            type: 'category',
            data: data.map(item => item.date)
        },
        yAxis: {
            type: 'value'
        },
        series: [
            {
                type: 'candlestick',
                data: data.map(item => [
                    item.open,
                    item.close,
                    item.low,
                    item.high
                ])
            }
        ]
    };
    candlestickChart.setOption(option);
}

// 监听公司选择
document.getElementById('companySelect').addEventListener('change', (e) => {
    const companyId = e.target.value;
    if (companyId) {
        loadCompanyData(companyId);
        loadTechnicalData(companyId);
    }
});

// 页面加载时获取市场数据
document.addEventListener('DOMContentLoaded', loadMarketData);

// 窗口大小改变时重绘图表
window.addEventListener('resize', () => {
    marketChart.resize();
    candlestickChart.resize();
    maChart.resize();
    rsiChart.resize();
    kdjChart.resize();
    macdChart.resize();
});
</script>
{% endblock %} 