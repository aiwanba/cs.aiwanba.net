# 股票交易游戏平台部署指南

## 一、环境准备

### 1.1 系统要求
- Linux 服务器 (推荐 Ubuntu 20.04 LTS)
- Python 3.11.9
- MySQL 5.7.40
- Nginx 1.18+

### 1.2 Python环境配置
```bash
# 安装 Python 3.11.9
sudo apt update
sudo apt install python3.11 python3.11-dev python3.11-venv

# 创建虚拟环境
cd /www/wwwroot/cs.aiwanba.net
python3.11 -m venv venv
source venv/bin/activate
```

### 1.3 安装项目依赖
```bash
# 使用清华镜像源安装依赖
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

## 二、数据库配置

### 2.1 MySQL安装和配置
```bash
# 安装MySQL
sudo apt install mysql-server-5.7

# 配置MySQL
sudo mysql_secure_installation

# 创建数据库和用户
mysql -u root -p
```

### 2.2 创建数据库和用户
```sql
CREATE DATABASE cs_aiwanba_net CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'cs_aiwanba_net'@'localhost' IDENTIFIED BY 'sQz9HSnF5ZcXj9SX';
GRANT ALL PRIVILEGES ON cs_aiwanba_net.* TO 'cs_aiwanba_net'@'localhost';
FLUSH PRIVILEGES;
```

## 三、项目部署

### 3.1 目录结构创建
```bash
# 创建项目目录
sudo mkdir -p /www/wwwroot/cs.aiwanba.net
sudo mkdir -p /www/wwwlogs/python/cs_aiwanba_net

# 设置目录权限
sudo chown -R www-data:www-data /www/wwwroot/cs.aiwanba.net
sudo chown -R www-data:www-data /www/wwwlogs/python/cs_aiwanba_net
```

### 3.2 数据库初始化
```bash
# 激活虚拟环境
source venv/bin/activate

# 初始化数据库
flask db upgrade
```

### 3.3 Gunicorn配置
```bash
# 启动Gunicorn
gunicorn -c gunicorn_conf.py app:app
```

### 3.4 Nginx配置
```nginx
server {
    listen 80;
    server_name localhost;  # 替换为实际域名

    location / {
        proxy_pass http://127.0.0.1:5010;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /socket.io {
        proxy_pass http://127.0.0.1:5010/socket.io;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

## 四、服务管理

### 4.1 创建系统服务
```bash
sudo nano /etc/systemd/system/cs_aiwanba_net.service
```

服务配置内容：
```ini
[Unit]
Description=CS AiWanBa Stock Game
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/www/wwwroot/cs.aiwanba.net
Environment="PATH=/www/wwwroot/cs.aiwanba.net/venv/bin"
ExecStart=/www/wwwroot/cs.aiwanba.net/venv/bin/gunicorn -c gunicorn_conf.py app:app
Restart=always

[Install]
WantedBy=multi-user.target
```

### 4.2 启动服务
```bash
sudo systemctl daemon-reload
sudo systemctl start cs_aiwanba_net
sudo systemctl enable cs_aiwanba_net
```

## 五、监控和维护

### 5.1 日志监控
```bash
# 查看应用日志
tail -f /www/wwwlogs/python/cs_aiwanba_net/gunicorn_error.log
tail -f /www/wwwlogs/python/cs_aiwanba_net/gunicorn_access.log

# 查看系统服务日志
sudo journalctl -u cs_aiwanba_net
```

### 5.2 性能监控
```bash
# 运行性能测试
cd /www/wwwroot/cs.aiwanba.net
source venv/bin/activate
python -m pytest tests/performance_test.py
```

### 5.3 数据库备份
```bash
# 创建备份目录
sudo mkdir -p /www/backup/cs_aiwanba_net

# 备份数据库
mysqldump -u cs_aiwanba_net -p cs_aiwanba_net > /www/backup/cs_aiwanba_net/backup_$(date +%Y%m%d).sql
```

## 六、故障排除

### 6.1 常见问题
1. 数据库连接失败
   - 检查数据库服务状态
   - 验证数据库用户名和密码
   - 确认数据库权限设置

2. WebSocket连接失败
   - 检查Nginx配置
   - 确认eventlet工作模式配置
   - 验证防火墙设置

3. 性能问题
   - 检查Gunicorn工作进程数
   - 优化数据库查询
   - 调整缓存策略

### 6.2 重启服务
```bash
sudo systemctl restart cs_aiwanba_net
sudo systemctl restart nginx
``` 